version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:7.0
    container_name: picam-mongodb
    restart: unless-stopped
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
      - ./scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    environment:
      - MONGO_INITDB_DATABASE=picam
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - picam-network

  # PICAM Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: picam-backend
    restart: unless-stopped
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - MONGODB_DATABASE=picam
      - DEBUG=${DEBUG:-false}
      - HOTEL_NAME=${HOTEL_NAME:-PICAM Demo Hotel}
      - FRONT_DESK_STATIONS=${FRONT_DESK_STATIONS:-3}
      - RESTAURANT_CAPACITY=${RESTAURANT_CAPACITY:-100}
      - AVG_ROOM_RATE=${AVG_ROOM_RATE:-150}
      - LABOR_COST_PER_HOUR=${LABOR_COST_PER_HOUR:-25}
      - CUSTOMER_TIME_VALUE_PER_MINUTE=${CUSTOMER_TIME_VALUE_PER_MINUTE:-2}
      - CONFIDENCE_LEVEL=${CONFIDENCE_LEVEL:-0.95}
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - picam-network

  # PICAM Frontend Dashboard
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - REACT_APP_API_URL=${REACT_APP_API_URL:-http://localhost:8000/api/v1}
    container_name: picam-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - picam-network

  # Data Seeder (one-time job)
  seeder:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: picam-seeder
    command: python -m app.scripts.seed_data
    environment:
      - MONGODB_URL=mongodb://mongodb:27017
      - MONGODB_DATABASE=picam
      - SEED_DAYS=${SEED_DAYS:-7}
    depends_on:
      mongodb:
        condition: service_healthy
    profiles:
      - seed
    networks:
      - picam-network

  # Mongo Express (Development only)
  mongo-express:
    image: mongo-express:1.0.0
    container_name: picam-mongo-express
    restart: unless-stopped
    ports:
      - "${MONGO_EXPRESS_PORT:-8081}:8081"
    environment:
      - ME_CONFIG_MONGODB_URL=mongodb://mongodb:27017
      - ME_CONFIG_BASICAUTH_USERNAME=${MONGO_EXPRESS_USER:-admin}
      - ME_CONFIG_BASICAUTH_PASSWORD=${MONGO_EXPRESS_PASS:-picam123}
    depends_on:
      mongodb:
        condition: service_healthy
    profiles:
      - dev
    networks:
      - picam-network

volumes:
  mongodb_data:
    name: picam-mongodb-data
  mongodb_config:
    name: picam-mongodb-config

networks:
  picam-network:
    name: picam-network
    driver: bridge